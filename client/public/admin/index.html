<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penny Finance - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0a0a0a; color: white; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .live-indicator { width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; box-shadow: 0 0 10px #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex items-center justify-between mb-12">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center font-bold text-black">P</div>
                <h1 class="text-2xl font-bold">Admin Analytics</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-red-500/10 px-4 py-2 rounded-full border border-red-500/20">
                    <div class="live-indicator"></div>
                    <span class="text-red-400 font-bold text-sm">LIVE</span>
                    <span class="text-white font-bold ml-2" id="online-count">0</span>
                    <span class="text-gray-400 text-xs uppercase ml-1">users online</span>
                </div>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-2xl p-6">
                <div class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Total Starts</div>
                <div class="text-4xl font-black text-white" id="total-traffic">0</div>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Completion</div>
                <div class="text-4xl font-black text-emerald-400" id="conversion-rate">0%</div>
            </div>
            <div class="glass rounded-2xl p-6 col-span-2">
                <div class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Traffic Trend (24h)</div>
                <div class="h-16 w-full">
                     <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>

        <div class="glass rounded-3xl p-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="filter"></i> Funnel Analysis (with Drop-off Alert)
            </h2>
            <div id="funnel-container" class="space-y-4">
                <div class="text-center text-gray-500 animate-pulse">Loading data...</div>
            </div>
        </div>
    </div>

    <script>
        // Init Socket
        // Init Socket
        const socket = io('https://penny-finance-backend.fly.dev', {
            transports: ['websocket', 'polling'],
            withCredentials: true
        });

        const statusEl = document.getElementById('online-count');
        statusEl.textContent = '...'; // Connecting state

        socket.on('connect', () => {
            console.log('✅ Connected');
            statusEl.style.color = '#10b981'; // Green
        });

        socket.on('connect_error', (err) => {
            console.error('❌ Socket Error:', err);
            statusEl.textContent = 'ERR';
            statusEl.style.color = '#ef4444'; // Red
            statusEl.title = err.message;
        });

        socket.on('update_online', (count) => {
            statusEl.textContent = count;
        });

        // Charts
        let trafficChartInstance = null;

        const STEPS = [
            { key: 'funnel_start', label: 'Started Quiz' },
            { key: 'question_1_answered', label: 'Q1' },
            { key: 'question_2_answered', label: 'Q2' },
            { key: 'question_3_answered', label: 'Q3' },
            { key: 'question_4_answered', label: 'Q4' },
            { key: 'question_5_answered', label: 'Q5' },
            { key: 'question_6_answered', label: 'Q6' },
            { key: 'question_7_answered', label: 'Q7' },
            { key: 'question_8_answered', label: 'Lead' },
            { key: 'funnel_completed', label: 'Completed' }
        ];

        async function fetchData() {
            try {
                const baseUrl = 'https://penny-finance-backend.fly.dev';
                
                // Fetch Stats
                const statsRes = await fetch(`${baseUrl}/api/analytics/stats`);
                const stats = await statsRes.json();
                renderFunnel(stats);

                // Fetch History
                const historyRes = await fetch(`${baseUrl}/api/analytics/hourly`);
                const history = await historyRes.json();
                renderChart(history);

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function renderFunnel(stats) {
            const container = document.getElementById('funnel-container');
            const total = stats.funnel_start || 0;
            const completed = stats.funnel_completed || 0;

            document.getElementById('total-traffic').textContent = total;
            document.getElementById('conversion-rate').textContent = total > 0 
                ? ((completed / total) * 100).toFixed(1) + '%' 
                : '0%';
            
            // If structure not built yet (or still showing loading), build it
            if (!document.getElementById('step-funnel_start')) {
                 container.innerHTML = ''; // Clear "Loading data..."
                 STEPS.forEach((step, index) => {
                    const html = `
                        <div class="relative group mb-4" id="step-${step.key}">
                            <div class="flex justify-between text-xs mb-1 font-medium text-gray-400">
                                <span class="step-label">${step.label}</span>
                                <div class="flex gap-4">
                                    <span class="step-retention opacity-70"></span>
                                    <span class="step-count text-white">0</span>
                                </div>
                            </div>
                            <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                                <div class="step-bar h-full rounded-full bg-indigo-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            }

            // Update values seamlessly
            STEPS.forEach((step, index) => {
                const count = stats[step.key] || 0;
                const percent = total > 0 ? Math.round((count / total) * 100) : 0;
                
                // Dropoff Logic
                const prevCount = index > 0 ? (stats[STEPS[index-1].key] || 0) : total;
                const stepRetention = prevCount > 0 ? (count / prevCount) : 0;
                const dropoffRate = 1 - stepRetention;
                const isBottleneck = index > 0 && dropoffRate > 0.2;

                // DOM Updates
                const el = document.getElementById(`step-${step.key}`);
                if (el) {
                    el.querySelector('.step-count').textContent = count;
                    el.querySelector('.step-bar').style.width = `${percent}%`;
                    
                    // Update Colors/Alerts dynamically
                    const labelEl = el.querySelector('.step-label');
                    const barEl = el.querySelector('.step-bar');
                    
                    if (step.key === 'funnel_completed') {
                        barEl.className = 'step-bar h-full rounded-full bg-emerald-500 transition-all duration-500';
                    } else if (isBottleneck) {
                        barEl.className = 'step-bar h-full rounded-full bg-red-500 transition-all duration-500';
                        if (!labelEl.innerHTML.includes('⚠️')) labelEl.innerHTML += ' <span class="text-red-400">⚠️ HIGH DROP-OFF</span>';
                    } else {
                        barEl.className = 'step-bar h-full rounded-full bg-indigo-500 transition-all duration-500';
                        // Clean warning if resolved
                         if (labelEl.innerHTML.includes('⚠️')) labelEl.innerHTML = step.label;
                    }

                    if (index > 0) {
                        el.querySelector('.step-retention').textContent = `Step Ret: ${(stepRetention*100).toFixed(0)}%`;
                    }
                }
            });
            lucide.createIcons();
        }

        function renderChart(history) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            const labels = history.map(h => h.hour.slice(11) + 'h'); // Extract HH
            const data = history.map(h => h.funnel_start || 0);

            if (trafficChartInstance) trafficChartInstance.destroy();

            trafficChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Starts',
                        data: data,
                        borderColor: '#10b981',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // Auto-refresh every 1s (Silent Mode)
        // Only runs if the tab is visible to save resources
        fetchData();
        setInterval(() => {
            if (!document.hidden) {
                fetchData();
            }
        }, 1000);
        lucide.createIcons();
    </script>
</body>
</html>
